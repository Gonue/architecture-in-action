# Ch01

### 단일 서버

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/db4e6a18-38ce-415c-bd52-6b1a6fcb9b0c)

사용자는 도메인 이름을 이용하여 웹사이트에 접속한다. 이 접속을 위해서는 도메인 이름을 도메인 이름 서비스에 질의하여 IP 주소로 변환하는 과정이 필요하다.
DNS 조회로 웹 서버의 IP 주소가 반환된다.
해당 IP 주소로 HTTP 요청이 전달된다.
요청을 받은 웹 서버는 HTML 페이지나 JSON 형태의 응답을 반환한다.


### 데이터 베이스
사용자가 늘면 서버 하나로는 충분하지 않아서 여러 서버를 두어야 한다. 하나는 웹/모바일 트래픽 처리 용도고, 다른 하나는 데이터베이스용이다.

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/8e3dfb60-51c2-4487-9129-acd0f6e1f42a)

데이터베이스는 크게 RDBMS, NoSQL 2가지로 나눌 수 있다. 대체적으로는 RDBMS로 해결할 수 있고 적절한 상황이지만, 아래와 같은 경우에는 NoSQL이 적절한 선택일 수 있다.

```
- 아주 낮은 응답 지연시간이 요구됨
- 다루는 데이터가 비정형이라 관계형 데이터가 아님
- 데이터를 직렬화하거나 역직렬화할 수 있기만 하면 됨
- 아주 많은 양의 데이터를 저장할 필요가 있음
```

### 수직적 규모 확장 vs 수평적 규모 확장

스케일 업(scale up): 수직적 규모 확장은 서버에 고사양 자원(더 좋은 CPU, 더 많은 RAM)을 추가하는 것

스케일 아웃(scale out): 수평적 규모 확장은 더 많은 서버를 추가하여 성능을 개선하는 행위

서버로 유입되는 트래픽의 양이 적을 때는 수직적 확장이 좋은 선택이며, 이 방법의 가장 큰 장점은 단순함이다. 그러나 스케일 업에는 심각한 단점이 존재한다.

- 한 대의 서버에 CPU나 메모리를 무한대로 증성할 방법은 없다.
- 장애에 대한 자동복구(failover) 방안이나 다중화 방안을 제시하지 않는다. 서버에 장애가 발생하면 웹사이트/앱은 완전히 중단된다.

위와 같은 단점 때문에, 대규모 애플리케이션을 지원하는 데는 수평적 규모 확장법이 보다 적절하다.

### 로드밸런서

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/8b2fc171-2ec5-4271-9154-7fc60dc17297)

사용자는 로드밸런서의 Public IP로 접속한다. 서버 간 통신에는 Private IP가 이용된다. 위처럼 스케일 아웃을 통해서 서버를 여러 대로 늘리게 되면 no failover도 해소할 수 있고, 웹 계층의 가용성은 향상된다.

### 데이터베이스 다중화

데이터베이스를 Master-Slave로 나누는데 쓰기 연산은 Master에서만 지원하고, 읽기 연산은 Slave에서만 지원한다. 대부분의 애플리케이션에서는 쓰기 작업 보다는 읽기 작업이 훨씬 많기 때문에 Slave 데이터베이스가 훨씬 많다.

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/3c14d482-0ace-42b6-819e-16f1465e7418)

데이터베이스 다중화의 장점
- 더 나은 성능 : 모든 데이터 변경 연산은 Master 서버로만 전달되는 반면 읽기 연산은 Slave 데이터베이스 서버들로 분산된다. 병렬로 처리될 수 있는 쿼리의 수가 늘어나므로 성능이 좋아진다.
- 안전성: 데이터베이스 서버 가운데 일부가 파괴되어도 데이터는 보존될 것이다. 데이터를 지역적으로 떨어진 여러 장소에 다중화 시켜놓을 수 있기 때문이다.
- 가용성: 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스 서버에 장애가 발생하더라도 다른 서버에 있는 데이터를 가져와 계속 서비스할 수 있게 된다.

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/bb825075-1a61-4d01-b996-42efa3bef453)

```
사용자는 DNS로부터 로드밸런서의 공개 IP 주소를 받는다.
사용자는 해당 IP 주소를 사용해 로드밸런서에 접속한다.
HTTP 요청은 서버 1이나 서버 2로 전송된다.
웹 서버는 사용자의 데이터를 부 데이터베이스 서버에서 읽는다.
웹 서버는 데이터 변경 연산은 주 데이터베이스로 전달한다.
```

### 캐시

캐시는 값 비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소이다. 애플리케이션의 성능은 데이터베이스를 얼마나 자주 호출하느냐에 크게 좌우되는데, 캐시는 그런 문제를 완화할 수 있다.

### 캐시 계층

캐시 계층은 데이터가 잠시 보관되는 곳으로 데이터베이스보다 훨씬 빠르다.

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/0d7d8e41-95cb-4414-a3d6-61f3064b038e)


```
요청을 받은 웹 서버는 캐시에 응답이 저장되어 있는지를 확인한다.
만일 저장되어 있다면 해당 데이터를 클라이언트에 반환한다.
없는 경우에는 데이터베이스 쿼리를 통해 데이터를 찾아 캐시에 저장한 뒤 클라이언트에 반환한다.
```

### 캐시 사용 시 유의할 점

- 캐시는 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어난다면 고려해볼만 하다.
영속적으로 보관할 데이터를 캐시에 두는 것은 바람직하지 않다.
- 캐시는 데이터를 휘발성 메모리에 두기 때문에, 캐시 서버가 재시작되면 모든 데이터는 사라진다.
- 만료된 데이터는 캐시에서 삭제되어야 한다.
  - 만료 기한에 대한 정책을 마련하는 것이 좋다.
  - 만료 기한이 너무 짧으면, 데이터베이스를 너무 자주 읽게 되며, 너무 길면 원본과 차이가 날 가능성이 높아진다.
- 데이터 저장소의 원본과 캐시 내의 사본 일관성을 확인해야 한다.
캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점(SPOF)이 되어 버릴 수 있다.
- 캐시 메모리 크기는 너무 크지도 작지도 않게 적절하게 잡아야 한다.
- 캐시가 꽉 차버리면 LRU, LFU, FIFO 같은 정책들을 사용해서 사용해야 한다.

### 콘텐츠 전송 네트워크(CDN)

CDN은 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크이다. 이미지, 비디오, CSS, JavaScript 파일 등을 캐시할 수 있다.

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/807fdd88-8f8a-4220-b875-62bc3aea349f)

```
- 사용자 A가 이미지 URL을 이용해 image.png에 접근한다.
- CDN 서버의 캐시에 해당 이미지가 없는 경우, 서버는 원본 서버에 요청하여 파일을 가져온다.
- 원본 서버가 파일을 CDN 서버에 반환한다.
- CDN 서버는 파일을 캐시하고 사용자 A에게 반환한다.
- 사용자 B가 같은 이미지에 대한 요청을 CDN 서버에 전송한다.
- 만료되지 않은 이미지에 대한 요청은 캐시를 통해 처리된다.
```

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/2fffb03a-2850-41a1-ba65-3c3d4e8fba9d)

- 정적 컨텐츠(JS, CSS, 이미지 등)는 더 이상 웹 서버를 통해 서비스하지 않으며, CDN을 통해 제공하여 더 나은 성능을 보장합니다.
- 캐시가 데이터베이스 부하를 줄어줍니다.

### 무상태(stateless) 웹 계층

웹 계층을 수평적으로 확장하는 방법
HTTP 같은 경우는 stateless 하기 때문에 세션 같은 정보는 저장을 해두어야 한다. 세션 정보를 서버 내부 메모리와 같은 곳에 사용할 수 있는데, 그런데 만약 서버가 여러 대라면 어떻게 세션 정보를 유지할 수 있을까?

세션은 요청에 대한 context다.

![image](https://github.com/Gonue/architecture-in-action/assets/109960034/b7c36c86-4dbb-4a5f-a41a-98743c046741)

